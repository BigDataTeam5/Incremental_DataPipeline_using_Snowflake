name: CO2 Data Pipeline CI/CD

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Debug Environment Variables
        run: |
          echo "SNOWFLAKE_ACCOUNT=${{ secrets.SNOWFLAKE_ACCOUNT }}"
          echo "SNOWFLAKE_USER=${{ secrets.SNOWFLAKE_USER }}"
          echo "SNOWFLAKE_PASSWORD=${{ secrets.SNOWFLAKE_PASSWORD }}"
          echo "SNOWFLAKE_WAREHOUSE=${{ secrets.SNOWFLAKE_WAREHOUSE }}"
          echo "AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}"
          echo "AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}"
      - name: Run tests
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE: CO2_ROLE  # Default role
          SNOWFLAKE_WAREHOUSE: CO2_WH
          SNOWFLAKE_SCHEMA: RAW_CO2
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
        run: |
          cd tests
          pytest testing_snowflake_connection.py
          pytest testing_s3_connection.py
          pytest testing_volatility_co2ppm.py
          pytest testing_daily_percent_change.py
          pytest testing_weekly_changes.py
          cd ../..

  deploy:
    needs: test
    if: success() && (github.event_name != 'pull_request')
    runs-on: ubuntu-latest
    env:
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_WAREHOUSE: CO2_WH
      AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
      AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
      DATABASE_NAME: CO2_DB_PROD # Or use a secret if needed
      SCHEMA_NAME: RAW_CO2       # Or use a secret if needed

    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set environment variables
        run: |
          echo "AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}" >> $GITHUB_ENV
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
            echo "DATABASE_NAME=CO2_DB_PROD" >> $GITHUB_ENV
            echo "SNOWFLAKE_ROLE=CO2_ROLE_PROD" >> $GITHUB_ENV  # Set prod role
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
            echo "DATABASE_NAME=CO2_DB_DEV" >> $GITHUB_ENV
            echo "SNOWFLAKE_ROLE=CO2_ROLE_DEV" >> $GITHUB_ENV  # Set dev role
          fi

      - name: Debug Environment Variables Before Deployment
        run: |
          echo "ENVIRONMENT=$ENVIRONMENT"
          echo "DATABASE_NAME=$DATABASE_NAME"
          echo "SNOWFLAKE_ROLE=$SNOWFLAKE_ROLE"
          echo "SNOWFLAKE_ACCOUNT=$SNOWFLAKE_ACCOUNT"
          echo "SNOWFLAKE_USER=$SNOWFLAKE_USER"
          echo "SNOWFLAKE_WAREHOUSE=$SNOWFLAKE_WAREHOUSE"

      - name: Generate configuration and SQL files
        run: |
          echo "AWS_ACCESS_KEY=$AWS_ACCESS_KEY" > .env
          echo "AWS_SECRET_KEY=$AWS_SECRET_KEY" >> .env
          python scripts/render_yaml.py $ENVIRONMENT
          python scripts/render_setup.py $ENVIRONMENT

      - name: Check Snowflake CLI Version
        run: |
          snow --version

      - name: Setup Snowflake
        run: |
          echo "Running setup SQL script..."
          snow sql -f scripts/setup_${ENVIRONMENT}.sql \
                    --accountname $SNOWFLAKE_ACCOUNT \
                    --user $SNOWFLAKE_USER \
                    --role $SNOWFLAKE_ROLE \
                    --warehouse $SNOWFLAKE_WAREHOUSE \
                    --database $DATABASE_NAME \
                    --schema $SCHEMA_NAME \
                    --temporary-connection

      - name: Deploy UDFs and Stored Procedures
        run: |
          echo "Deploying UDFs and Stored Procedures..."
          # Deploy using temporary connection
          for dir in udfs_and_spoc/*; do
            if [ -d "$dir" ]; then
              echo "Deploying project in $dir"
              cd "$dir"
              snow snowpark build --temporary-connection \
                  --account $SNOWFLAKE_ACCOUNT \
                  --user $SNOWFLAKE_USER \
                  --role $SNOWFLAKE_ROLE \
                  --warehouse $SNOWFLAKE_WAREHOUSE \
                  --database $DATABASE_NAME
              snow snowpark deploy --replace --temporary-connection \
                  --account $SNOWFLAKE_ACCOUNT \
                  --user $SNOWFLAKE_USER \
                  --role $SNOWFLAKE_ROLE \
                  --warehouse $SNOWFLAKE_WAREHOUSE \
                  --database $DATABASE_NAME
              cd -
            fi
          done

      - name: Orchestrate Tasks
        run: |        
          echo "Orchestrating tasks for $ENVIRONMENT environment..."
          snow sql --accountname $SNOWFLAKE_ACCOUNT \
                    --user $SNOWFLAKE_USER \
                    --role $SNOWFLAKE_ROLE \
                    --warehouse $SNOWFLAKE_WAREHOUSE \
                    --database $DATABASE_NAME \
                    --schema $SCHEMA_NAME \
                    -f scripts/orchestrate_tasks_${ENVIRONMENT}.sql
         
          echo "Deployment complete. Tasks successfully orchestrated."